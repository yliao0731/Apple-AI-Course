<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apple Intelligence (AI) 教學重點懶人包</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 移除 Tone.js (背景音樂函式庫) -->
    <style>
        /* 設置 Inter 字體為優先，並確保中文字體顯示良好 */
        body {
            font-family: 'Inter', 'Noto Sans TC', 'PingFang TC', sans-serif;
            background-color: #f7f7f7;
            color: #1f2937;
        }
        /* 標題配色使用 Apple 相關的深色系 */
        .header-bg {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
        }
        /* 卡片底色使用淺色，搭配圓角和陰影 */
        .card {
            background-color: white;
            border-radius: 1.5rem; /* 更圓潤的圓角 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease-in-out;
        }
        .card:hover {
            /* 讓卡片在滑鼠懸停時略微抬升 */
            transform: translateY(-4px);
        }
        /* 表格樣式 */
        .custom-table th, .custom-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .custom-table th {
            background-color: #f3f4f6;
            color: #4b5563;
            font-weight: 600;
        }
        .custom-table tr:last-child td {
            border-bottom: none;
        }
        /* Accordion 內容預設隱藏，使用過渡效果 */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0 1rem;
        }
        /* 展開狀態 */
        .accordion-content.active {
            max-height: 800px; /* 增加最大高度以容納更多內容 */
            padding: 1rem;
        }
        /* 箭頭旋轉效果 */
        .accordion-icon {
            transition: transform 0.4s;
        }
        .accordion-icon.rotate {
            transform: rotate(180deg);
        }
        /* Loading 旋轉動畫 */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        /* 提醒動畫 */
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* NEW: 持續提醒光暈 (更明顯的視覺震動/催促) */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(253, 224, 71, 0.7); } /* Yellow-200 */
            70% { box-shadow: 0 0 0 10px rgba(253, 224, 71, 0); }
            100% { box-shadow: 0 0 0 0 rgba(253, 224, 71, 0); }
        }
        .reminder-glow {
            animation: pulse-glow 1.5s infinite;
            border: 2px solid #FDE047; /* Yellow-400 */
        }
    </style>
</head>
<body onclick="resetInactivityTimer()">
    <!-- 主標題區塊 -->
    <header class="header-bg text-white p-6 rounded-b-2xl shadow-xl">
        <div class="max-w-4xl mx-auto">
            <div class="flex justify-between items-center mb-2">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-extrabold mb-1">📘 Apple Intelligence (AI) 互動教材</h1>
                    <p class="text-sm font-light opacity-80">點擊區塊，探索 AI 核心功能細節！</p>
                </div>
                <!-- 導航按鈕 -->
                <div class="space-x-3 flex items-center">
                    <a href="quiz.html" class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        前往測驗
                    </a>
                    <a href="hub.html" class="bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-md">
                        回中心頁
                    </a>
                </div>
            </div>

            <!-- NPC 語音引導區塊 (小萊恩 IP) -->
            <div id="npc-container" class="mt-4 p-3 bg-white/10 backdrop-blur-sm rounded-xl flex items-center shadow-lg">
                <!-- 圖像按鈕 - 使用上傳的 IP 圖檔 -->
                <button id="speaker-btn" onclick="handleSpeakerClick()" class="relative p-0 mr-3 rounded-full bg-transparent transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 transform hover:scale-105" aria-label="播放語音引導">
                    <!-- 漫畫 IP 圖片 (已從 video 替換為 img) -->
                    <img id="speaker-icon" 
                           src="uploaded:老萊恩去背.png-a7f1b070-e704-41fd-85fc-1c478bbb0588" 
                           alt="小萊恩 IP 圖形" 
                           class="w-12 h-12 rounded-full object-cover">
                    
                    <!-- Loading Spinner (絕對定位疊在圖片上方) -->
                    <div id="loading-spinner" class="hidden absolute inset-0 rounded-full flex items-center justify-center bg-gray-800/80">
                        <svg class="w-6 h-6 text-white spinner" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path fill="currentColor" d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"/><path fill="currentColor" d="M12 4.5v3a4.5 4.5 0 00-4.5 4.5H4.5A7.5 7.5 0 0112 4.5z"/></svg>
                    </div>
                </button>
                
                <span id="guidance-text" class="text-white text-sm">點擊頭像，聆聽小萊恩的介紹。</span>
            </div>
            
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 space-y-12">
        
        <!-- 介紹 -->
        <section class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">簡介：系統層級智慧功能</h2>
            <p class="text-gray-600 leading-relaxed">
                Apple Intelligence 是蘋果公司首次將【生成式 AI 模型】深度整合到 【iOS、iPadOS 和 macOS】 中的【系統層級智慧功能】。它專注於個人化、隱私保護，並在所有 App 中提供一致的智慧輔助。
            </p>
        </section>

        <!-- 一、系統與隱私基礎 (表格不需互動，保持參考性) -->
        <section class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="mr-3 text-2xl text-blue-600">🛡️</span>一、系統與隱私基礎
            </h2>
            <div class="overflow-x-auto">
                <table class="custom-table w-full min-w-[600px] border-collapse">
                    <thead>
                        <tr>
                            <th class="rounded-tl-xl">項目</th>
                            <th>說明與優勢</th>
                            <th class="rounded-tr-xl">應用場景舉例</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold text-gray-700 w-1/4">系統級整合</td>
                            <td class="w-1/2">AI 功能深度植入作業系統核心，可在【所有 App (原生或第三方)】的【輸入框中調用】。</td>
                            <td class="w-1/4">寫郵件時，可立即請 AI 調整語氣為「專業」或「輕鬆」。</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-gray-700">隱私優先架構</td>
                            <td>優先採用 【裝置端處理 (On-Device Processing)】，確保【個人資料不離開裝置】。</td>
                            <td>總結個人訊息對話內容時，數據完全在 iPhone 內運算。</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-gray-700">私密雲端運算</td>
                            <td>若遇複雜任務需要雲端運算，則透過 【Private Cloud Compute (PCC)】，保證資料【不被蘋果存取或儲存】。</td>
                            <td>生成複雜圖像時，可安全地利用雲端資源而不犧牲隱私。</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 二、三大核心能力 (使用互動式 Accordion) -->
        <section id="core-sections" class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="mr-3 text-2xl text-red-500">✨</span>二、三大核心能力 (點擊展開)
            </h2>
            <div class="space-y-4">
                
                <!-- 1. 寫作工具 -->
                <div id="writing-tools-accordion" class="bg-yellow-100/50 p-4 rounded-lg border-l-4 border-yellow-500 cursor-pointer hover:bg-yellow-100 transition duration-200" onclick="handleAccordionClick('writing-tools')">
                    <h3 class="text-xl font-bold text-gray-800 flex justify-between items-center">
                        1. 寫作工具 (Writing Tools)
                        <span id="icon-writing-tools" class="accordion-icon text-xl">▼</span>
                    </h3>
                </div>
                <div id="writing-tools" class="accordion-content">
                    <ul class="list-disc list-inside space-y-3 text-gray-700 ml-4 p-4 border-t border-gray-200">
                        <li>【系統級寫作輔助】：可在系統【任何文本輸入區域】（如郵件、訊息、備忘錄）一鍵呼叫。</li>
                        <li>【主要功能】：【潤飾/風格調整】（改變語氣：專業、輕鬆、簡潔）、【校對/語法修正】（自動修正錯誤並建議優化）、【總結/摘要】（快速提取長文重點）。</li>
                        <li class="mt-4 text-sm text-gray-500">【詳細設定方式】：在輸入框中【長按或點擊 AI 魔法棒圖示】即可啟動寫作工具。可預設【風格偏好】或【目標字數】範圍。</li>
                    </ul>
                </div>

                <!-- 2. 圖像創作 -->
                <div id="image-creation-accordion" class="bg-green-100/50 p-4 rounded-lg border-l-4 border-green-500 cursor-pointer hover:bg-green-100 transition duration-200" onclick="handleAccordionClick('image-creation')">
                    <h3 class="text-xl font-bold text-gray-800 flex justify-between items-center">
                        2. 圖像創作 (Image Creation)
                        <span id="icon-image-creation" class="accordion-icon text-xl">▼</span>
                    </h3>
                </div>
                <div id="image-creation" class="accordion-content">
                    <ul class="list-disc list-inside space-y-3 text-gray-700 ml-4 p-4 border-t border-gray-200">
                        <li>【影像樂園 (Image Playground)】：透過【簡單的文字描述】，在【裝置端快速生成】圖片。</li>
                        <li>【風格選項】：支援【動畫 (Animation)】、【素描 (Sketch)】、【插畫 (Illustration)】 等多種藝術風格。</li>
                        <li>【Genmoji】：透過【自定義文字】生成獨特的【AI 表情符號】，可直接在訊息App中作為反應或貼圖使用。</li>
                        <li class="mt-4 text-sm text-gray-500">【詳細設定方式】：在「訊息 App」的【輸入框左側點擊 + 號】，選擇 【影像樂園】 即可進入創作介面。</li>
                    </ul>
                </div>

                <!-- 3. 情境感知 Siri -->
                <div id="siri-context-accordion" class="bg-purple-100/50 p-4 rounded-lg border-l-4 border-purple-500 cursor-pointer hover:bg-purple-100 transition duration-200" onclick="handleAccordionClick('siri-context')">
                    <h3 class="text-xl font-bold text-gray-800 flex justify-between items-center">
                        3. 情境感知 Siri
                        <span id="icon-siri-context" class="accordion-icon text-xl">▼</span>
                    </h3>
                </div>
                <div id="siri-context" class="accordion-content">
                    <ul class="list-disc list-inside space-y-3 text-gray-700 ml-4 p-4 border-t border-gray-200">
                        <li>【螢幕內容感知】：Siri 現在能夠【理解螢幕上正在顯示的內容】，例如：看到某個地址時，可直接要求「將這個地址儲存到通訊錄」。</li>
                        <li>【跨 App 記憶】：能執行涉及【多個應用程式和記憶上下文】的複雜指令。</li>
                        <li>【指令範例】：例如：「找出 Jane 傳給我關於上次旅行的郵件裡那張【穿紅色外套】的照片」。</li>
                        <li class="mt-4 text-sm text-gray-500">【詳細設定方式】：預設長按側邊按鈕或語音喚醒，但須到 【設定 > Siri 與搜尋】 中開啟【螢幕內容使用權限】以啟動上下文感知功能。</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- 三、App 深度整合應用 -->
        <section class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <span class="mr-3 text-2xl text-teal-600">📱</span>三、App 深度整合應用
            </h2>
            <!-- 表格維持非互動式，作為快速參考 -->
            <div class="overflow-x-auto">
                <table class="custom-table w-full min-w-[600px] border-collapse">
                    <thead>
                        <tr>
                            <th class="rounded-tl-xl">App 類別</th>
                            <th class="rounded-tr-xl">主要 AI 應用功能</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-semibold text-gray-700 w-1/3">郵件 (Mail)</td>
                            <td class="w-2/3">【智慧收件箱】： 【自動分類高優先級郵件】。【摘要功能】： 【長篇郵件一鍵總結】，快速掌握重點。</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-gray-700">提醒事項 / 備忘錄</td>
                            <td>【自動任務建議】： 根據【郵件、訊息、行事曆內容】，【主動建議】【使用者可加入的待辦事項或任務】。</td>
                        </tr>
                        <tr>
                            <td class="font-semibold text-gray-700">照片 (Photos)</td>
                            <td>【搜尋強化】： 支援【自然語言搜尋】，例如：「【找出 Jane 穿紅色外套在海邊拍的照片】」。【清除功能 (Clean Up)】： 【智慧移除照片中不需要的背景物體或人物】。</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>
    
    <!-- 頁尾 -->
    <footer class="mt-12 p-4 text-center text-gray-500 text-sm">
        &copy; 2025 Apple Intelligence 教學資料 - 僅供參考與學習
    </footer>

    <!-- JavaScript for Interactivity and TTS -->
    <script>
        // --- 狀態和配置 ---
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        // 語音已更改為 Puck (歡快/活潑)，原為 Charon
        const TTS_VOICE = "Puck"; 

        // IP 角色更名為 小萊恩
        const NPC_TITLE = "小萊恩"; 
        // 語音文本使用新名稱
        const TTS_INITIAL = `哈囉，我是 ${NPC_TITLE}！歡迎來到 Apple Intelligence 課程。請點擊下方的【三大核心能力】區塊，開始探索智慧功能和隱私基礎吧！`; 
        const TTS_REMINDER = `嘿，同學！我是 ${NPC_TITLE}！時間到了，請記得點擊任一核心能力區塊 (例如：寫作工具) 展開詳細內容喔！`;
        const TTS_COMPLETED_PROMPT = "課程已全部完成！請點擊頭像，聽取前往測驗的引導。"; // 文字提示
        const TTS_QUIZ_INSTRUCTION = "恭喜！您已完成三大核心能力的學習。現在，請點擊右上角的 [前往測驗] 按鈕，檢視您的學習成果吧！"; // 實際語音內容

        // 1. 不同的讚美方式 & 2. 內容重點
        const SECTION_PRAISES = {
            // 讚美多樣化
            'writing-tools': "做得太棒了！您成功解鎖了第一項功能，表現非常優秀。", 
            'image-creation': "哇，進度神速！圖像創作是 AI 最吸睛的能力之一，做得很好。", 
            'siri-context': "學得真快！情境感知 Siri 是實現跨應用程式智慧的關鍵喔，您掌握得非常棒。" 
        };
        const SECTION_SUMMARIES = { 
            'writing-tools': "【寫作工具】是您在郵件、備忘錄中最實用的 AI 助理。它能幫您【一鍵潤飾、校對或總結】長篇文字，大幅提升寫作效率。",
            'image-creation': "您正在了解【圖像創作】能力。這包含了【影像樂園】和 【Genmoji】，讓您能快速生成【各種風格的圖片】和【獨特的表情符號】。",
            'siri-context': "【情境感知 Siri】是 Apple Intelligence 的核心。她現在能【理解螢幕上的內容】，並執行【跨應用程式的複雜指令】。"
        };
        
        const completedSections = new Set();
        let inactivityTimer = null;
        let audio = null; 
        // 追蹤當前的語音指令狀態：initial -> active (學習中) -> quiz_pending_5s (5秒倒數) -> quiz_ready (可點擊聽取測驗指令)
        let currentInstruction = 'initial'; 

        // --- DOM 元素 ---
        const speakerBtn = document.getElementById('speaker-btn');
        const speakerIcon = document.getElementById('speaker-icon');
        const loadingSpinner = document.getElementById('loading-spinner');
        const guidanceText = document.getElementById('guidance-text');
        const coreSectionsContainer = document.getElementById('core-sections');
        const npcContainer = document.getElementById('npc-container'); 
        // 移除 musicControl 變數

        // --- 播放與控制邏輯 ---

        /** * 啟用 Loading 狀態並更新文字 */
        function startLoading(message) {
            if (audio && !audio.paused) {
                audio.pause();
                audio.currentTime = 0;
            }
            speakerBtn.disabled = true;
            speakerIcon.classList.add('hidden'); // 隱藏 IP 圖像/影片
            loadingSpinner.classList.remove('hidden'); // 顯示 Spinner
            guidanceText.textContent = message;
            // 停止瀏覽器語音合成
            window.speechSynthesis.cancel(); 
        }

        /** * 停止 Loading 狀態並恢復按鈕 */
        function stopLoading(message) {
            guidanceText.textContent = message;
            speakerBtn.disabled = false;
            speakerIcon.classList.remove('hidden'); // 顯示 IP 圖像/影片
            loadingSpinner.classList.add('hidden'); // 隱藏 Spinner
        }
        
        /**
         * 瀏覽器內建語音備援 (Local Fallback)
         * @param {string} message - 要說的文本
         */
        function speakLocalFallback(message) {
            startLoading(`🔊 備援語音播放中... (${NPC_TITLE})`);
            
            const utterance = new SpeechSynthesisUtterance(message);
            utterance.lang = 'zh-TW'; // 設定為中文
            
            utterance.onend = () => {
                stopLoading(`點擊頭像，聆聽 ${NPC_TITLE} 的介紹。`);
                if (currentInstruction === 'active') {
                    startInactivityTimer();
                } else if (currentInstruction === 'quiz_ready') {
                    guidanceText.textContent = "請點擊 [前往測驗] 按鈕，開始檢視學習成果！";
                }
            };

            // 確保音訊播放結束時才停止 loading
            try {
                 window.speechSynthesis.speak(utterance);
            } catch (error) {
                 console.error("瀏覽器語音備援失敗:", error);
                 stopLoading(`備援語音失敗。請檢查您的瀏覽器設定。`);
            }
        }


        /**
         * 處理喇叭按鈕的點擊事件，根據狀態播放正確的語音
         */
        function handleSpeakerClick() {
            if (speakerBtn.disabled) return; 

            // 點擊按鈕，移除持續的光暈提醒
            npcContainer.classList.remove('reminder-glow');

            let messageToSpeak;

            if (currentInstruction === 'initial' || currentInstruction === 'active') {
                messageToSpeak = TTS_INITIAL;
                currentInstruction = 'active'; 
            } else if (currentInstruction === 'reminder') {
                messageToSpeak = TTS_REMINDER;
                currentInstruction = 'active'; 
            } else if (currentInstruction === 'quiz_ready') {
                 messageToSpeak = TTS_QUIZ_INSTRUCTION;
                 currentInstruction = 'finished'; 
            } else if (currentInstruction === 'quiz_pending_5s' || currentInstruction === 'finished') {
                guidanceText.textContent = currentInstruction === 'finished' ? "課程已結束，請前往測驗。" : "請稍候，課程完成提醒即將發出。";
                return;
            }
            
            // 點擊後隨即出現語音 (立刻呼叫 API)
            speakGuidance(messageToSpeak);
            
            coreSectionsContainer.classList.remove('shake');
            document.querySelector('header').classList.remove('shake');
        }

        // --- TTS 輔助函數 (PCM to WAV 轉換) ---
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(samples, sampleRate) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);
            
            writeString(view, 0, 'RIFF'); 
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt '); 
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); 
            view.setUint16(22, 1, true); 
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            let offset = 44;
            for (let i = 0; i < samples.length; i++, offset += 2) {
                view.setInt16(offset, samples[i], true);
            }
            
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        async function speakGuidance(message) {
            resetInactivityTimer();
            startLoading(`${NPC_TITLE} 正在生成語音中，請稍候...`);
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: `Say in a relaxed and cheerful tone: ${message}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: TTS_VOICE } } }
                },
                model: TTS_MODEL
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const status = response.status;
                    
                    // NEW: 403 錯誤處理，切換至本地備援語音
                    if (status === 403) {
                         console.warn("TTS API 權限不足 (403 Forbidden)。切換至瀏覽器本地語音備援。");
                         stopLoading(`🚨 錯誤 403：API 權限不足，正使用本地備援語音。`);
                         speakLocalFallback(message);
                         return; // 成功切換備援，結束函式
                    }
                    
                    throw new Error(`API 錯誤: ${status} ${response.statusText}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    if (!rateMatch) throw new Error("無法解析採樣率。");
                    
                    const sampleRate = parseInt(rateMatch[1], 10);
                    const pcmBuffer = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    // 確保每次都創建新的 Audio 實例
                    audio = new Audio(audioUrl);
                    
                    audio.onplay = () => {
                        guidanceText.textContent = `播放中... (${NPC_TITLE}: Puck)`;
                    };
                    audio.onended = () => {
                        stopLoading(`點擊頭像，聆聽 ${NPC_TITLE} 的介紹。`);
                        
                        if (currentInstruction === 'active') {
                             startInactivityTimer();
                        } else if (currentInstruction === 'quiz_ready') {
                             guidanceText.textContent = "請點擊 [前往測驗] 按鈕，開始檢視學習成果！";
                        }
                    };
                    // 播放音訊
                    audio.play();
                } else {
                    throw new Error("API 返回的音訊數據結構無效或缺少數據。");
                }
            } catch (error) {
                console.error("TTS 發生嚴重錯誤:", error);
                // 最終備援：如果連備援都失敗，則切換至本地備援
                speakLocalFallback(message);
            }
        }


        // --- 課程狀態與計時器邏輯 (保持原樣) ---
        
        /** * 啟動 5 秒不活動提醒計時器 */
        function startInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (currentInstruction === 'active') {
                inactivityTimer = setTimeout(() => {
                    // 達到 5 秒催促點
                    currentInstruction = 'reminder';
                    guidanceText.textContent = "超過 5 秒未互動！請點擊頭像，聆聽小萊恩的催促提醒！";
                    coreSectionsContainer.classList.add('shake'); // 核心區塊晃動 (瞬時)
                    setTimeout(() => coreSectionsContainer.classList.remove('shake'), 1000);
                    
                    // 維持震動/閃爍直到點擊 (使用持續光暈)
                    npcContainer.classList.add('reminder-glow'); 

                }, 5000); 
            }
        }

        /** * 重設不活動計時器 */
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            // 移除光暈，無論是否在提醒狀態
            npcContainer.classList.remove('reminder-glow'); 
            
            if (currentInstruction === 'active') {
                startInactivityTimer();
            }
        }

        /**
         * 處理 Accordion 點擊事件，包含狀態追蹤和語音反饋
         */
        function handleAccordionClick(id) {
            resetInactivityTimer(); 
            
            toggleAccordion(id);
            
            const content = document.getElementById(id);
            if (!content.classList.contains('active')) {
                return;
            }
            
            // 檢查是否已完成，並給予反饋
            if (!completedSections.has(id)) {
                completedSections.add(id);
                
                // 不同的讚美方式 + 內容總結
                const praise = SECTION_PRAISES[id];
                const summary = SECTION_SUMMARIES[id];
                const fullMessage = `${praise}！您成功展開了區塊。接著，${summary}`;
                
                // 語音出現的速度 (點擊後隨即開始 API 呼叫)
                speakGuidance(fullMessage);
                
                // 檢查課程完成度
                if (completedSections.size === 3) {
                    // 進入 5 秒倒數狀態
                    currentInstruction = 'quiz_pending_5s';
                    
                    // 課程完成後 5 秒提醒
                    setTimeout(() => {
                        if (currentInstruction === 'quiz_pending_5s') {
                            currentInstruction = 'quiz_ready'; 
                            guidanceText.textContent = TTS_COMPLETED_PROMPT; 
                            // 頂部區塊晃動 (瞬時)
                            document.querySelector('header').classList.add('shake'); 
                            setTimeout(() => document.querySelector('header').classList.remove('shake'), 1000);

                            // 維持閃爍直到點擊
                            npcContainer.classList.add('reminder-glow');
                        }
                    }, 5000); 
                } else {
                    currentInstruction = 'active'; 
                }
            } else {
                 guidanceText.textContent = "您已經學過這一區塊囉！";
                 currentInstruction = 'active';
            }

            coreSectionsContainer.classList.remove('shake');
        }

        // --- 輔助函數：Accordion 展開/收合邏輯 (保持原樣) ---
        function toggleAccordion(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            
            const isActive = content.classList.contains('active');

            document.querySelectorAll('.accordion-content').forEach(item => {
                if (item.id !== id) {
                    item.classList.remove('active');
                    item.style.maxHeight = 0;
                }
            });
            document.querySelectorAll('.accordion-icon').forEach(item => {
                if (item.id !== `icon-${id}`) {
                    item.classList.remove('rotate');
                }
            });

            if (!isActive) {
                content.classList.add('active');
                // 使用 scrollHeight 確保內容完全展開
                content.style.maxHeight = content.scrollHeight + 100 + "px"; 
                icon.classList.add('rotate');
            } else {
                content.classList.remove('active');
                content.style.maxHeight = 0;
                icon.classList.remove('rotate');
            }
        }


        // --- 頁面初始化 ---
        window.addEventListener('load', () => {
            // 初始提示在 DOM 中設置，等待用戶點擊頭像按鈕
            guidanceText.textContent = `點擊頭像，開始 ${NPC_TITLE} 的介紹。`;
            
            document.querySelectorAll('.accordion-content').forEach(content => {
                if (!content.classList.contains('active')) {
                    content.style.maxHeight = 0;
                }
            });
        });
    </script>
</body>
</html>
